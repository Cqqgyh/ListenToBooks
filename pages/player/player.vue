<template>
	<view>
		<view class="gui-relative" style="background-color: #7d7d4b;">
			<view class="gui-p-t-40 gui-flex gui-row">
				<view class="gui-flex gui-flex1 gui-row gui-justify-content-start gui-p-l-20 gui-align-items-center">
					<view class="gui-icons gui-color-white  gui-m-r-40" @click="closePopup">&#xe603;</view>
					<gui-switch-navigation
						:activeLineClass="['gui-nav-scale', 'gui-bg-white']"
						:titleClass="['gui-color-white']"
						:items="[{ id: 0, name: '播放' }, { id: 1, name: '评论' }]"
						activeLineWidth="50rpx"
						:size="100"
						:width="200"
						:currentIndex="currentIndex"
						@change="navchange"
					></gui-switch-navigation>
				</view>
				<view class="gui-flex gui-row  gui-p-l-20 gui-p-r-20 gui-align-items-center">
					<text class="gui-icons gui-block gui-color-white gui-m-r-10">&#xe606;</text>
					<text class="gui-text-small gui-color-white">分享</text>
				</view>
			</view>

			<swiper class="tab-card-body" :current="currentIndex" :style="{ height: swiperHeight + 'px' }">
				<swiper-item>
					<scroll-view scroll-y :style="{ height: scrollHeight  + 'px' }">
						<view class="gui-relative gui-flex gui-justify-content-center gui-m-l-100 gui-m-r-100 gui-m-t-30 gui-m-b-30">
							<view
								class="gui-flex gui-absolute-lb gui-bg-black-opacity7 gui-p-l-5 gui-p-r-5 gui-text-small gui-color-white gui-p-t-5 gui-p-b-5 gui-p-l-20 gui-p-r-20"
							>
								<text class="gui-icons gui-block gui-color-drak gui-m-r-5 gui-p-t-5">&#xe649;</text>
								<text>{{ trackStaVo?.playStatNum }}</text>
							</view>
							<image
								class="gui-border-radius"
								mode="aspectFill"
								:src="trackInfo?.coverUrl"
							></image>
						</view>

						<view class="gui-flex gui-column gui-align-items-center gui-justify-content-center  gui-m-l-50 gui-m-r-50 gui-m-t-30 gui-m-b-30">
							<text>{{ trackInfo?.trackTitle }}</text>
							<view class="gui-flex gui-row gui-align-items-center gui-m-t-20">
								<image
									class="gui-small-avatar"
									mode="aspectFill"
									src="https://images.unsplash.com/photo-1663603802898-798d83877992?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxlZGl0b3JpYWwtZmVlZHw0OHx8fGVufDB8fHx8&auto=format&fit=crop&w=100&q=90"
								></image>

								<text class="gui-color-yellow gui-text-small gui-m-r-20 gui-m-l-20 gui-flex">
									<text>新经典</text>
									<text class="gui-icons">&#xe601;</text>
								</text>
								<view class="gui-flex gui-row gui-text-small gui-justify-content-center gui-color-white gui-bg-black-opacity2 gui-border-radius gui-p-10">
									<text class="gui-icons gui-m-r-5 gui-p-t-5">&#xe6c7;</text>
									<text>关注</text>
								</view>
							</view>
						</view>

						<view class="gui-flex gui-row gui-space-between gui-align-items-center gui-m-l-50 gui-m-r-50 gui-m-t-30 gui-m-b-30">
							<text class="iconfont gui-m-r-5 gui-p-t-5 gui-color-white gui-h5">{{ audioContxt.currentTime }}</text>
							<view class="gui-flex1 gui-m-l-20 gui-m-r-20">
								<!-- <gui-single-slider
									:canSlide="true"
									:barHeight="20"
									:barWidth="20"
									:bglineClass="['gui-bg-white']"
									:barClass="['gui-bg-green', 'gui-color-white']"
								></gui-single-slider> -->
								<slider
									:value="audioContxt.percentTime"
									step="1"
									activeColor="#f86442"
									block-color="#fff" 
									block-size="20" 
									@change="sliderChange"
								/>
							</view>
							<text class="iconfont gui-m-r-5 gui-p-t-5 gui-color-white gui-h5">{{ audioContxt.duration }}</text>
						</view>

						<view class="gui-flex gui-row gui-space-between gui-m-l-50 gui-m-r-50 gui-m-t-30 gui-m-b-30 gui-align-items-center">
							<text class="gui-icons gui-m-r-5 gui-p-t-5 gui-color-white gui-h5">&#xe648;</text>

							<text class="gui-icons gui-m-r-5 gui-p-t-5 gui-color-white gui-h2">&#xe659;</text>
							<text class="iconfont gui-m-r-5 gui-p-t-5 gui-color-white gui-h1" @click="play">&#xe624;</text>
							<text class="iconfont gui-m-r-5 gui-p-t-5 gui-color-white gui-h1" @click="pause">&#xe649;</text>
							<text class="gui-icons gui-m-r-5 gui-p-t-5 gui-color-white gui-h2">&#xe65a;</text>

							<text class="gui-icons gui-m-r-5 gui-p-t-5 gui-color-white gui-h5">&#xe64c;</text>
						</view>

						<view class="gui-list-items  gui-m-l-50 gui-m-r-50 gui-m-t-30 gui-m-b-30 gui-bg-black-opacity1 gui-p-20">
							<view class="gui-list-image">
								<image
									class="gui-list-image"
									mode="aspectFill"
									src="https://images.unsplash.com/photo-1663603802898-798d83877992?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxlZGl0b3JpYWwtZmVlZHw0OHx8fGVufDB8fHx8&auto=format&fit=crop&w=100&q=90"
								></image>
							</view>
							<view class="gui-list-body">
								<view class="gui-list-title">
									<text class="gui-text gui-block gui-secondary-text gui-text-left gui-ellipsis gui-color-white">
										[新民间剧场]寻龙天师寻龙天师寻龙天师寻龙天师寻龙天师寻龙天师
									</text>
								</view>
								<text class="gui-list-body-desc gui-text-brown gui-m-t-10 gui-ellipsis">{{ trackStaVo?.collectStatNum }}人订阅</text>
							</view>

							<view class="gui-p-10 gui-border-radius gui-m-l-20 gui-bg-black-opacity2 gui-flex gui-align-items-center">
								<text class="gui-icons gui-text-brown gui-text-small gui-m-r-10">&#xe6c7;</text>
								<text class="gui-text-small gui-text-brown">免费订阅</text>
							</view>
						</view>
					</scroll-view>

					<view class="gui-absolute-lb gui-bg-black-opacity1 gui-p-t-20 gui-p-b-20 gui-color-white" style="width:100%;">
						<view class="gui-flex gui-row gui-space-between gui-m-l-50 gui-m-r-50 gui-text-center">
							<view class="gui-flex gui-column gui-align-items-center">
								<text class="gui-icons gui-h3 gui-m-b-5">&#xe60a;</text>
								<text class="gui-text-small">99+</text>
							</view>
							<view class="gui-flex gui-row gui-bg-black-opacity1 gui-border-radius gui-p-t-10 gui-p-b-10 gui-p-l-30 gui-p-r-30 gui-align-items-center">
								<text class="gui-icons gui-m-b-5 gui-m-r-10">&#xe69e;</text>
								<text>发表评论</text>
							</view>
							<view class="gui-flex gui-column gui-align-items-center">
								<text class="gui-icons gui-h3 gui-m-b-5">&#xe6ea;</text>
								<text class="gui-text-small">2.8万</text>
							</view>
							<view class="gui-flex gui-column gui-align-items-center">
								<text class="gui-icons gui-h3 gui-m-b-5">&#xe645;</text>
								<text class="gui-text-small">1987</text>
							</view>
							<view class="gui-flex gui-column gui-align-items-center">
								<text class="gui-icons gui-h3 gui-m-b-5">&#xe6b8;</text>
								<text class="gui-text-small">{{ trackStaVo?.albumCommentStatNum }}</text>
							</view>
						</view>
					</view>
				</swiper-item>
				<swiper-item>
					<view class="gui-flex gui-space-around gui-bg-white gui-m-t-30 gui-p-t-30  gui-p-l-30 gui-p-r-30 gui-bg-white">
						<view class="gui-flex gui-flex1 gui-justify-content-start gui-align-items-center">
							<text class="gui-icons gui-block gui-m-r-5">&#xe6b8;</text>
							<text>我要评价</text>
						</view>
						<view class="gui-flex gui-flex1 gui-justify-content-end"><gui-star></gui-star></view>
					</view>
					<scroll-view scroll-y :style="{ height: scrollHeight  + 'px' }" class="gui-border-box  gui-p-l-30 gui-p-r-30 gui-bg-white">
						<CommentList></CommentList>
					</scroll-view>
				</swiper-item>
			</swiper>
		</view>
	</view>
</template>

<script setup lang="ts">
import graceJS from '@/Grace6/js/grace.js';
import { albumsService } from "../../api"
import {
  TrackInfoInterface,
	TrackStaVoInterface
} from "../../api/albums/interfaces"
import { ref, computed, onMounted, reactive } from 'vue';
import { onLoad } from "@dcloudio/uni-app"
import { formatTime } from '../../utils/utils'
const systemHeight = ref(0);
const swiperHeight = computed(() => {
	return systemHeight.value - uni.upx2px(113);
});
const scrollHeight = computed(() => {
	return systemHeight.value - uni.upx2px(113) - uni.upx2px(135);
});
const currentIndex = ref(0);

// 初始化音频控件
const innerAudioContext = uni.createInnerAudioContext();
innerAudioContext.autoplay = true;

// 音频相关信息
let trackInfo = ref<TrackInfoInterface>()
// 音频统计信息
let trackStaVo  = ref<TrackStaVoInterface>()

// 音频相关参数
const audioContxt = reactive({
	/** 音频总时长 */
	duration: '00:00',
	/** 音频总时长，秒格式 */
	durationTime: 0,
	/** 当前进度 */
	currentTime: '00:00',
	/** 进度条时间 */
	percentTime: 0
})

const navchange = index => {
	currentIndex.value = index;
};

/**
 * @description: 获取声音信息
 * @returns {*}
 */
const getTrackInfo = async (id:number) => {
  try {
    const res = await albumsService.getTrackInfo(id)
		trackInfo.value = res.data
		createAudioText()
  } catch (error) {
    console.log(error)
  }
}

/**
 * @description: 获取声音统计信息
 * @param {*} id
 * @returns {*}
 */
const getTrackStatVo = async (id: number) => {
	try {
		const res = await albumsService.getTrackStaVo(id)
		trackStaVo.value = res.data
	} catch(error) {
		console.log(error)
	}
}

/**
 * @description: 播放进度条发生变化
 * @returns {*}
 */
const sliderChange = (e) => {
	console.log(e);
}

// 
const createAudioText = () => {
	// 测试音频地址
	// innerAudioContext.src = 'https://bjetxgzv.cdn.bspapp.com/VKCEYUGU-hello-uniapp/2cc220e0-c27a-11ea-9dfb-6da8e309e0d8.mp3';
	innerAudioContext.src = trackInfo.value?.mediaUrl;
	initAudio(innerAudioContext)
}
/**
 * @description: 暂停音频
 * @returns {*}
 */
const pause = () => {
	innerAudioContext.pause() // 停止
}

/**
 * @description: 播放音频
 * @returns {*}
 */
const play = () => {
	innerAudioContext.play() // 播放
}

/** 初始化音频 */
const initAudio = (ctx: any) => {
	ctx.onTimeUpdate((e) => {
		
		// 获取当前进度
		const currentTime:number = innerAudioContext.currentTime
		
		// console.log(audioContxt.percentTime);
		
		if (audioContxt.durationTime) {
			audioContxt.percentTime = (currentTime / audioContxt.durationTime) * 1000
			// console.log(audioContxt.percentTime);
		}
		
		audioContxt.currentTime = formatTime(currentTime);
	})
	ctx.onCanplay(() => {
		// 获取音频长度
		setTimeout(() => { 
			console.log('音频长度', innerAudioContext.duration);
			// 转化成时分秒的格式
			const duration = innerAudioContext.duration
			audioContxt.durationTime = duration
			audioContxt.duration = formatTime(duration);
		}, 300)
	})
	ctx.onWaiting((e) => {
		
	})
	ctx.onPlay((e) => {
		
	})
	ctx.onPause((e) => {
		
	})
	ctx.onEnded((e) => {
		
	})
	ctx.onError((e) => {
		
	})
}

onLoad(() => {
	getTrackInfo(1)
	getTrackStatVo(1)
})

onMounted(() => {
	var systemInfo = graceJS.system();
	systemHeight.value = systemInfo.safeArea.height;
});
</script>

<style lang="scss">
.gui-small-avatar {
	width: 50rpx;
	height: 50rpx;
	border-radius: 50%;
}

.gui-text-brown {
	color: #b3a598;
}

.gui-text-brown-light {
	color: #e2bb92;
}
</style>
